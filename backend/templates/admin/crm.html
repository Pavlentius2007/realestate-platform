<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ CRM –°–∏—Å—Ç–µ–º–∞ - Sianoro Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem 1rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-x: auto;
        }

        .crm-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .crm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .nav-link {
            border-radius: 10px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: var(--primary-gradient);
            color: white !important;
        }

        .nav-link.active {
            background: var(--primary-gradient);
            color: white !important;
        }

        .stat-card {
            background: linear-gradient(45deg, #f8f9fa, #ffffff);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
        }

        .stat-card:hover {
            transform: scale(1.02);
        }

        .stat-card.leads { border-left-color: #3b82f6; }
        .stat-card.hot { border-left-color: #ef4444; }
        .stat-card.qualified { border-left-color: #10b981; }
        .stat-card.conversion { border-left-color: #f59e0b; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .funnel-stage {
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .funnel-stage:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .funnel-bar {
            height: 10px;
            border-radius: 5px;
            margin: 1rem 0;
            transition: width 0.5s ease;
        }

        .lead-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .lead-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .lead-item.new { border-left-color: #3b82f6; }
        .lead-item.contacted { border-left-color: #10b981; }
        .lead-item.qualified { border-left-color: #f59e0b; }
        .lead-item.closed { border-left-color: #8b5cf6; }

        .conversion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .progress-ring {
            width: 60px;
            height: 60px;
        }

        .progress-circle {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 4;
        }

        .progress-circle-fill {
            fill: none;
            stroke: #667eea;
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dasharray 0.3s ease;
        }

        .quick-action-btn {
            background: var(--success-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white;
        }

        .quick-action-btn.danger {
            background: var(--danger-gradient);
        }

        .quick-action-btn.warning {
            background: var(--warning-gradient);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="sidebar">
            <h3 class="text-center mb-4">
                <span style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    üè¢ Sianoro Admin
                </span>
            </h3>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/admin">
                        üìä –ì–ª–∞–≤–Ω–∞—è
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/properties">
                        üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/projects">
                        üèóÔ∏è –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/rental">
                        üìã –ê—Ä–µ–Ω–¥–∞
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/users">
                        üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/articles">
                        üì∞ –°—Ç–∞—Ç—å–∏
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/analytics">
                        üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/reports">
                        üìã –û—Ç—á–µ—Ç—ã
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/crm">
                        üéØ CRM
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/logs">
                        üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
                    </a>
                </li>
            </ul>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üéØ CRM –°–∏—Å—Ç–µ–º–∞</h2>
                <div>
                    <a href="/admin/crm/leads" class="quick-action-btn">
                        üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–¥–∞–º–∏
                    </a>
                    <a href="/admin/crm/pipeline" class="quick-action-btn warning">
                        üìä –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂
                    </a>
                    <a href="/admin/crm/interactions" class="quick-action-btn danger">
                        üí¨ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
                    </a>
                </div>
            </div>

            {% if error %}
                <div class="alert alert-danger">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CRM –¥–∞–Ω–Ω—ã—Ö: {{ error }}
                </div>
            {% elif crm %}
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card leads">
                            <div class="mb-2">üìù</div>
                            <div class="stat-number">{{ crm.stats.total_leads }}</div>
                            <div class="text-muted">–í—Å–µ–≥–æ –ª–∏–¥–æ–≤</div>
                            <small class="text-success">+{{ crm.stats.new_leads_week }} –∑–∞ –Ω–µ–¥–µ–ª—é</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card hot">
                            <div class="mb-2">üî•</div>
                            <div class="stat-number">{{ crm.stats.hot_leads }}</div>
                            <div class="text-muted">–ì–æ—Ä—è—á–∏–µ –ª–∏–¥—ã</div>
                            <small class="text-info">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card qualified">
                            <div class="mb-2">‚úÖ</div>
                            <div class="stat-number">{{ crm.funnel_data.qualified }}</div>
                            <div class="text-muted">–ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</div>
                            <small class="text-success">{{ "%.1f"|format((crm.funnel_data.qualified / crm.stats.total_leads * 100) if crm.stats.total_leads > 0 else 0) }}% –∫–æ–Ω–≤–µ—Ä—Å–∏—è</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card conversion">
                            <div class="mb-2">üí∞</div>
                            <div class="stat-number">{{ "%.1f"|format(crm.stats.conversion_rate) }}%</div>
                            <div class="text-muted">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                            <small class="text-info">–û—Ç –ª–∏–¥–∞ –¥–æ —Å–¥–µ–ª–∫–∏</small>
                        </div>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                <div class="row">
                    <!-- –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ -->
                    <div class="col-md-8">
                        <div class="crm-card">
                            <h4 class="mb-4">üìä –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h4>
                            
                            {% if crm.funnel_data %}
                            <div class="funnel-stage">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>üìù –õ–∏–¥—ã</h5>
                                    <span class="badge bg-primary">{{ crm.funnel_data.leads }}</span>
                                </div>
                                <div class="funnel-bar" style="background: #3b82f6; width: 100%;"></div>
                                <small class="text-muted">–í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏</small>
                            </div>
                            
                            <div class="funnel-stage">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>üîç –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</h5>
                                    <span class="badge bg-success">{{ crm.funnel_data.qualified }}</span>
                                </div>
                                <div class="funnel-bar" style="background: #10b981; width: {{ (crm.funnel_data.qualified / crm.funnel_data.leads * 100) if crm.funnel_data.leads > 0 else 0 }}%;"></div>
                                <small class="text-muted">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å</small>
                            </div>
                            
                            <div class="funnel-stage">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>üìã –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h5>
                                    <span class="badge bg-warning">{{ crm.funnel_data.proposals }}</span>
                                </div>
                                <div class="funnel-bar" style="background: #f59e0b; width: {{ (crm.funnel_data.proposals / crm.funnel_data.leads * 100) if crm.funnel_data.leads > 0 else 0 }}%;"></div>
                                <small class="text-muted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</small>
                            </div>
                            
                            <div class="funnel-stage">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>ü§ù –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</h5>
                                    <span class="badge bg-danger">{{ crm.funnel_data.deals }}</span>
                                </div>
                                <div class="funnel-bar" style="background: #ef4444; width: {{ (crm.funnel_data.deals / crm.funnel_data.leads * 100) if crm.funnel_data.leads > 0 else 0 }}%;"></div>
                                <small class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</small>
                            </div>
                            
                            <div class="funnel-stage">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5>‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏</h5>
                                    <span class="badge bg-purple">{{ crm.funnel_data.closed }}</span>
                                </div>
                                <div class="funnel-bar" style="background: #8b5cf6; width: {{ (crm.funnel_data.closed / crm.funnel_data.leads * 100) if crm.funnel_data.leads > 0 else 0 }}%;"></div>
                                <small class="text-muted">–£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º -->
                    <div class="col-md-4">
                        <div class="crm-card">
                            <h4 class="mb-4">üåç –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</h4>
                            
                            {% if crm.conversion_data %}
                                {% for source in crm.conversion_data %}
                                <div class="conversion-item">
                                    <div>
                                        <h6 class="mb-1">{{ source.source }}</h6>
                                        <small class="text-muted">{{ source.total_leads }} –ª–∏–¥–æ–≤</small>
                                    </div>
                                    <div class="text-end">
                                        <svg class="progress-ring" viewBox="0 0 36 36">
                                            <circle class="progress-circle" cx="18" cy="18" r="15"></circle>
                                            <circle class="progress-circle-fill" cx="18" cy="18" r="15" 
                                                    stroke-dasharray="{{ source.conversion_rate }}, 100"></circle>
                                        </svg>
                                        <div class="mt-1">
                                            <strong>{{ source.conversion_rate }}%</strong>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <div class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="crm-card">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h4>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–∏–¥—ã</h4>
                                <a href="/admin/crm/leads" class="quick-action-btn">
                                    üëÄ –í—Å–µ –ª–∏–¥—ã
                                </a>
                            </div>
                            
                            {% if crm.recent_leads %}
                                {% for lead in crm.recent_leads %}
                                <div class="lead-item new">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">{{ lead.full_name or '–ë–µ–∑ –∏–º–µ–Ω–∏' }}</h6>
                                            <small class="text-muted">
                                                üìû {{ lead.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }} | 
                                                üì± {{ lead.whatsapp_number or '–ù–µ—Ç WhatsApp' }} | 
                                                üí¨ {{ lead.telegram_id or '–ù–µ—Ç Telegram' }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <div class="mb-1">
                                                <span class="badge bg-info">{{ lead.source or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span>
                                            </div>
                                            <small class="text-muted">{{ lead.created_at.strftime('%d.%m.%Y %H:%M') if lead.created_at else '' }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <div class="text-muted">
                                        <h5>üìù –ù–µ—Ç –ª–∏–¥–æ–≤</h5>
                                        <p>–õ–∏–¥—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            {% else %}
                <div class="text-center py-5">
                    <div class="crm-card">
                        <div class="mb-3">üéØ</div>
                        <h5 class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ CRM –¥–∞–Ω–Ω—ã—Ö...</h5>
                        <p class="text-muted">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–∏–¥—ã –∏ –≤–æ—Ä–æ–Ω–∫—É –ø—Ä–æ–¥–∞–∂</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            const funnelBars = document.querySelectorAll('.funnel-bar');
            
            funnelBars.forEach((bar, index) => {
                setTimeout(() => {
                    bar.style.transition = 'width 1s ease';
                    const width = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 100);
                }, index * 200);
            });
        });
    </script>
</body>
</html> 