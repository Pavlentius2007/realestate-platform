{% extends 'base.html' %}

{% block title %}ü§ñ –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ - Sianoro{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
            ü§ñ –£–º–Ω—ã–π –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
            –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ –æ –≤–∞—à–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è—Ö, –∏ —è –Ω–∞–π–¥—É –∏–¥–µ–∞–ª—å–Ω—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –≤ –ü–∞—Ç—Ç–∞–π–µ!
            –Ø –ø–æ–Ω–∏–º–∞—é –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ—á—å –∏ —É—á–∏—Ç—ã–≤–∞—é –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- –ß–∞—Ç -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="mr-3">üí¨</span>
                        –ß–∞—Ç —Å –ò–ò-–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º
                    </h2>
                    <p class="text-blue-100 mt-2">–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ</p>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="chat-messages" class="h-96 overflow-y-auto p-6 bg-gray-50">
                    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                    <div class="mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                ü§ñ
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-2xl p-4 shadow-sm">
                                    <p class="text-gray-800">
                                        –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –ü–∞—Ç—Ç–∞–π–µ. 
                                        –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ:
                                    </p>
                                    <ul class="mt-3 space-y-1 text-sm text-gray-600">
                                        <li>‚Ä¢ –ö–∞–∫–æ–π —É –≤–∞—Å –±—é–¥–∂–µ—Ç?</li>
                                        <li>‚Ä¢ –î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å? (–∂–∏–∑–Ω—å, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –æ—Ç–¥—ã—Ö)</li>
                                        <li>‚Ä¢ –ö–∞–∫–æ–π —Ä–∞–π–æ–Ω –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?</li>
                                        <li>‚Ä¢ –°–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç –Ω—É–∂–Ω–æ?</li>
                                        <li>‚Ä¢ –ï—Å—Ç—å –ª–∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è?</li>
                                    </ul>
                                    <p class="mt-3 text-sm text-blue-600 font-medium">
                                        –ù–∞–ø—Ä–∏–º–µ—Ä: "–ò—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É –¥–æ 5 –º–ª–Ω –±–∞—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ –ü–∞—Ç—Ç–∞–π–∏ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è, 2 —Å–ø–∞–ª—å–Ω–∏, —Å –±–∞—Å—Å–µ–π–Ω–æ–º"
                                    </p>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
                <div class="p-6 bg-white border-t">
                    <form id="chat-form" class="space-y-4">
                        <div class="flex space-x-4">
                            <input type="text" 
                                   id="user-message" 
                                   name="message"
                                   placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ... –Ω–∞–ø—Ä–∏–º–µ—Ä: '–ù—É–∂–Ω–∞ –≤–∏–ª–ª–∞ —Å –≤–∏–¥–æ–º –Ω–∞ –º–æ—Ä–µ –¥–æ 10 –º–ª–Ω –±–∞—Ç'"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button type="submit" 
                                    id="send-button"
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition duration-200 flex items-center space-x-2">
                                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                        <input type="hidden" id="session-id" name="session_id" value="">
                    </form>
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="space-y-6">
            <!-- –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
                <div class="space-y-2">
                    <button class="quick-request w-full text-left px-4 py-2 text-sm bg-blue-50 hover:bg-blue-100 rounded-lg transition"
                            data-message="–ò—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É –¥–æ 3 –º–ª–Ω –±–∞—Ç –≤ –î–∂–æ–º—Ç—å–µ–Ω–µ">
                        üèñÔ∏è –ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –î–∂–æ–º—Ç—å–µ–Ω–µ –¥–æ 3 –º–ª–Ω
                    </button>
                    <button class="quick-request w-full text-left px-4 py-2 text-sm bg-green-50 hover:bg-green-100 rounded-lg transition"
                            data-message="–ù—É–∂–Ω–∞ –≤–∏–ª–ª–∞ —Å –±–∞—Å—Å–µ–π–Ω–æ–º –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π">
                        üè° –í–∏–ª–ª–∞ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
                    </button>
                    <button class="quick-request w-full text-left px-4 py-2 text-sm bg-purple-50 hover:bg-purple-100 rounded-lg transition"
                            data-message="–•–æ—á—É —Å—Ç—É–¥–∏—é —Ä—è–¥–æ–º —Å –ø–ª—è–∂–µ–º –¥–ª—è –æ—Ç–¥—ã—Ö–∞">
                        üèñÔ∏è –°—Ç—É–¥–∏—è —É –ø–ª—è–∂–∞
                    </button>
                    <button class="quick-request w-full text-left px-4 py-2 text-sm bg-orange-50 hover:bg-orange-100 rounded-lg transition"
                            data-message="–ò—â—É –ø–µ–Ω—Ç—Ö–∞—É—Å —Å –≤–∏–¥–æ–º –Ω–∞ –º–æ—Ä–µ">
                        üåä –ü–µ–Ω—Ç—Ö–∞—É—Å —Å –≤–∏–¥–æ–º –Ω–∞ –º–æ—Ä–µ
                    </button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üìä –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">–ö–æ–Ω–¥–æ –≤ —Ü–µ–Ω—Ç—Ä–µ</span>
                        <span class="text-sm font-medium text-blue-600">42%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">–í–∏–ª–ª–∞ —Å –±–∞—Å—Å–µ–π–Ω–æ–º</span>
                        <span class="text-sm font-medium text-green-600">28%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">–ö–≤–∞—Ä—Ç–∏—Ä–∞ —É –º–æ—Ä—è</span>
                        <span class="text-sm font-medium text-purple-600">21%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">–°—Ç—É–¥–∏—è –¥–ª—è –∞—Ä–µ–Ω–¥—ã</span>
                        <span class="text-sm font-medium text-orange-600">9%</span>
                    </div>
                </div>
            </div>

            <!-- –°–æ–≤–µ—Ç—ã -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üí° –°–æ–≤–µ—Ç—ã</h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <p>üó£Ô∏è –ì–æ–≤–æ—Ä–∏—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ - —è –ø–æ–Ω–∏–º–∞—é –æ–±—ã—á–Ω—É—é —Ä–µ—á—å</p>
                    <p>üí∞ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –±—é–¥–∂–µ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–¥–±–æ—Ä–∞</p>
                    <p>üìç –ù–∞–∑–æ–≤–∏—Ç–µ —Ä–∞–π–æ–Ω –∏–ª–∏ –±–ª–∏–∑–æ—Å—Ç—å –∫ –æ–±—ä–µ–∫—Ç–∞–º</p>
                    <p>üéØ –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª—å –ø–æ–∫—É–ø–∫–∏ (–∂–∏–∑–Ω—å/–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏/–æ—Ç–¥—ã—Ö)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
    <div id="search-results" class="mt-8 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üéØ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</h2>
        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const userMessageInput = document.getElementById('user-message');
    const sendButton = document.getElementById('send-button');
    const sessionIdInput = document.getElementById('session-id');
    const searchResults = document.getElementById('search-results');
    const resultsContainer = document.getElementById('results-container');
    const quickRequestButtons = document.querySelectorAll('.quick-request');

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Å–µ—Å—Å–∏–∏
    if (!sessionIdInput.value) {
        sessionIdInput.value = 'session_' + Math.random().toString(36).substr(2, 9);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    quickRequestButtons.forEach(button => {
        button.addEventListener('click', function() {
            const message = this.dataset.message;
            userMessageInput.value = message;
            chatForm.dispatchEvent(new Event('submit'));
        });
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = userMessageInput.value.trim();
        if (!message) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addUserMessage(message);
        userMessageInput.value = '';
        sendButton.disabled = true;
        sendButton.innerHTML = '<span>–î—É–º–∞—é...</span>';

        try {
            const response = await fetch(`/${window.location.pathname.split('/')[1]}/ai-chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    message: message,
                    session_id: sessionIdInput.value
                })
            });

            const data = await response.json();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò
            addAIMessage(data.response);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.properties && data.properties.length > 0) {
                showSearchResults(data.properties);
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            addAIMessage('–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        } finally {
            sendButton.disabled = false;
            sendButton.innerHTML = '<span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>';
        }
    });

    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-6';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3 justify-end">
                <div class="flex-1 text-right">
                    <div class="bg-blue-600 text-white rounded-2xl p-4 inline-block max-w-md">
                        <p>${escapeHtml(message)}</p>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
                <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    üë§
                </div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addAIMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-6';
        messageDiv.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                    ü§ñ
                </div>
                <div class="flex-1">
                    <div class="bg-white rounded-2xl p-4 shadow-sm">
                        <div class="prose prose-sm max-w-none">
                            ${formatAIMessage(message)}
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatAIMessage(message) {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ò–ò —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —ç–º–æ–¥–∑–∏ –∏ —Å–ø–∏—Å–∫–æ–≤
        return message
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^<br>/, '<p>')
            .replace(/<br>$/, '</p>')
            .replace(/^([^<])/, '<p>$1')
            .replace(/([^>])$/, '$1</p>')
            .replace(/‚Ä¢ /g, '<li>')
            .replace(/<li>/g, '</li><li>')
            .replace(/<\/li><li>([^<]*?)(<br>|<\/p>)/g, '<li>$1</li>$2')
            .replace(/(<li>.*?<\/li>)/s, '<ul>$1</ul>');
    }

    function showSearchResults(properties) {
        searchResults.classList.remove('hidden');
        resultsContainer.innerHTML = '';

        properties.forEach(property => {
            const propertyCard = document.createElement('div');
            propertyCard.className = 'bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition';
            propertyCard.innerHTML = `
                <img src="/static/images/${property.preview_image || 'default.jpg'}" 
                     alt="${property.title}" 
                     class="w-full h-48 object-cover">
                <div class="p-6">
                    <div class="text-2xl font-bold text-blue-600 mb-2">
                        ‡∏ø ${property.price ? property.price.toLocaleString() : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2 line-clamp-2">
                        ${property.title}
                    </h3>
                    <p class="text-gray-600 text-sm mb-4">
                        üìç ${property.district || '‚Äî'}, ${property.location || '‚Äî'}
                    </p>
                    <div class="flex justify-between text-sm text-gray-600 mb-4">
                        <span>üõèÔ∏è ${property.bedrooms || '‚Äî'} —Å–ø–∞–ª–µ–Ω</span>
                        <span>üìê ${property.area || '‚Äî'} –º¬≤</span>
                    </div>
                    <a href="/${window.location.pathname.split('/')[1]}/properties/${property.id}" 
                       class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 text-center block">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </a>
                </div>
            `;
            resultsContainer.appendChild(propertyCard);
        });

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
        searchResults.scrollIntoView({ behavior: 'smooth' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}