{% extends 'base.html' %}
{% block content %}

<!-- Современный hero-блок -->
<section class="relative w-full h-[380px] md:h-[420px] lg:h-[460px] flex items-center justify-center bg-cover bg-center" style="background-image: url('/static/img/hero-bg.jpg');">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative z-10 flex flex-col items-center justify-center w-full text-center px-4">
    <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold font-heading text-white mb-4 drop-shadow-lg">
      {{ _("site.title") }}
    </h1>
    <p class="text-lg md:text-xl lg:text-2xl text-white mb-8 drop-shadow max-w-2xl">
      {{ _("site.subtitle") }}
    </p>
  </div>
</section>

<!-- Универсальный поиск недвижимости -->
<section id="search-section" class="bg-white py-16">
  <div class="max-w-7xl mx-auto px-4">
    <div class="text-center mb-10">
      <h2 class="text-3xl md:text-4xl font-bold font-heading text-gray-900 mb-4">
        {{ _("search.title") }}
      </h2>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        {{ _("search.subtitle") }}
      </p>
    </div>

    <!-- Табы для выбора типа поиска -->
    <div class="bg-gray-50 rounded-3xl shadow-lg overflow-hidden">
      <!-- Переключатели табов -->
      <div class="flex flex-wrap justify-center bg-white border-b border-gray-200">
        <button onclick="switchSearchTab('buy')" 
                class="search-tab active flex-1 min-w-0 px-4 py-4 text-center font-semibold transition-all hover:bg-blue-50" 
                data-tab="buy">
          <span class="text-lg">🏠</span>
          <div class="font-medium">{{ _("search.tabs.buy") }}</div>
          <div class="text-xs text-gray-500">{{ _("navigation.properties") }}</div>
        </button>
        
        <button onclick="switchSearchTab('rent')" 
                class="search-tab flex-1 min-w-0 px-4 py-4 text-center font-semibold transition-all hover:bg-blue-50" 
                data-tab="rent">
          <span class="text-lg">🏖️</span>
          <div class="font-medium">{{ _("search.tabs.rent") }}</div>
          <div class="text-xs text-gray-500">{{ _("property.types.apartment") }}</div>
        </button>
        
        <button onclick="switchSearchTab('ai')" 
                class="search-tab flex-1 min-w-0 px-4 py-4 text-center font-semibold transition-all hover:bg-purple-50" 
                data-tab="ai">
          <span class="text-lg">🤖</span>
          <div class="font-medium">{{ _("search.tabs.ai") }}</div>
          <div class="text-xs text-gray-500">ИИ-подбор</div>
        </button>
        
        <button onclick="switchSearchTab('map')" 
                class="search-tab flex-1 min-w-0 px-4 py-4 text-center font-semibold transition-all hover:bg-green-50" 
                data-tab="map">
          <span class="text-lg">🗺️</span>
          <div class="font-medium">{{ _("search.tabs.map") }}</div>
          <div class="text-xs text-gray-500">Поиск по карте</div>
        </button>
      </div>

      <!-- Содержимое табов -->
      
                                  <!-- Таб: {{ _("navigation.buy_property") }} -->
      <div id="buy-tab" class="search-tab-content p-8 space-y-6" style="display: block;">
        <form class="space-y-6">
          <input type="hidden" name="deal_type" value="buy">
          
          <!-- Основные фильтры для покупки -->
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">🔍 {{ _("forms.project_district") }}</label>
              <input type="text" name="query" placeholder="{{ _('search.placeholder') }}"
                     class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 font-modern" />
            </div>
            
            <div>
                              <label class="block text-sm font-medium text-gray-700 mb-2">🏠 {{ _("forms.property_type") }}</label>
              <select name="property_type" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 font-modern">
                <option value="">{{ _("property.types.any") }}</option>
                <option value="apartment">{{ _("property.types.apartment") }}</option>
                <option value="condo">{{ _("property.types.condo") }}</option>
                <option value="villa">{{ _("property.types.villa") }}</option>
                <option value="townhouse">{{ _("property.types.townhouse") }}</option>
                <option value="house">{{ _("property.types.house") }}</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">💰 {{ _("property.budget") }}</label>
              <div class="flex gap-2">
                <input type="number" name="price_from" placeholder="{{ _('common.from') }}" step="0.1"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-blue-500 font-modern" />
                <input type="number" name="price_to" placeholder="{{ _('common.to') }}" step="0.1"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-blue-500 font-modern" />
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">🛏️ {{ _("property.bedrooms") }}</label>
              <select name="bedrooms" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 font-modern">
                <option value="">{{ _("common.any_amount") }}</option>
                <option value="0">{{ _("common.studio") }}</option>
                <option value="1">{{ _("common.1_bedroom") }}</option>
                <option value="2">{{ _("common.2_bedrooms") }}</option>
                <option value="3">{{ _("common.3_bedrooms") }}</option>
              </select>
            </div>
          </div>
          
          <!-- Специальные опции для покупки -->
          <div class="bg-blue-50 rounded-xl p-4">
            <div class="flex flex-wrap gap-4">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="new_building" class="rounded border-gray-300 text-blue-600">
                <span class="text-sm font-medium">🏗️ {{ _("common.new_buildings_only") }}</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="sea_view" class="rounded border-gray-300 text-blue-600">
                <span class="text-sm font-medium">🌊 {{ _("common.sea_view") }}</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="ready_to_move" class="rounded border-gray-300 text-blue-600">
                <span class="text-sm font-medium">✅ {{ _("common.ready_to_move") }}</span>
              </label>
            </div>
          </div>
          
          <!-- Подсказка об автоматическом поиске -->
          <div class="mt-4 text-center">
            <div class="inline-flex items-center gap-2 text-sm text-gray-500 bg-blue-50 px-4 py-2 rounded-lg">
              <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>{{ _("common.search_auto") }}</span>
            </div>
          </div>

        </form>
      </div>
      
                                  <!-- Таб: {{ _("navigation.rent_property") }} -->
      <div id="rent-tab" class="search-tab-content p-8 space-y-6" style="display: none;">
        <form class="space-y-6">
          <input type="hidden" name="deal_type" value="rent">
          
          <!-- Основные фильтры для аренды -->
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">🔍 {{ _("forms.project_district") }}</label>
              <input type="text" name="query" placeholder="{{ _('search.placeholder') }}"
                     class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 font-modern" />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">🏠 {{ _("forms.property_type") }}</label>
              <select name="property_type" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 font-modern">
                <option value="">{{ _("common.any_type") }}</option>
                <option value="apartment">{{ _("common.apartments") }}</option>
                <option value="condo">{{ _("common.condo") }}</option>
                <option value="villa">{{ _("common.villa") }}</option>
                <option value="studio">{{ _("common.studio_flat") }}</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">💰 {{ _("common.budget_monthly") }}</label>
              <div class="flex gap-2">
                <input type="number" name="price_from" placeholder="{{ _('common.from') }}" step="5"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-green-500 font-modern" />
                <input type="number" name="price_to" placeholder="{{ _('common.to') }}" step="5"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-green-500 font-modern" />
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">📅 {{ _("common.rental_period") }}</label>
              <select name="rental_period" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 font-modern">
                <option value="">{{ _("common.any_period") }}</option>
                <option value="short">{{ _("common.short_term") }}</option>
                <option value="medium">{{ _("common.medium_term") }}</option>
                <option value="long">{{ _("common.long_term") }}</option>
              </select>
            </div>
          </div>
          
          <!-- Удобства для аренды -->
          <div class="bg-green-50 rounded-xl p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <label class="flex items-center gap-2">
                <input type="checkbox" name="furnished" class="rounded border-gray-300 text-green-600">
                <span class="text-sm">🛋️ {{ _("amenities.furnished") }}</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="pets_allowed" class="rounded border-gray-300 text-green-600">
                <span class="text-sm">🐕 {{ _("amenities.pets_allowed") }}</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="pool" class="rounded border-gray-300 text-green-600">
                <span class="text-sm">🏊 {{ _("amenities.pool") }}</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="gym" class="rounded border-gray-300 text-green-600">
                <span class="text-sm">💪 {{ _("amenities.gym") }}</span>
              </label>
            </div>
          </div>
          
          <!-- Подсказка об автоматическом поиске -->
          <div class="mt-4 text-center">
            <div class="inline-flex items-center gap-2 text-sm text-gray-500 bg-green-50 px-4 py-2 rounded-lg">
              <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>{{ _("common.search_auto") }}</span>
            </div>
          </div>

        </form>
      </div>
      
      <!-- Таб: Умный поиск -->
      <div id="ai-tab" class="search-tab-content p-8 space-y-6" style="display: none;">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">🤖</div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">{{ _("ai.title") }}</h3>
          <p class="text-gray-600">{{ _("ai.subtitle") }}</p>
        </div>
        
        <form class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                          <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("forms.deal_type") }}</label>
            <select name="search_type" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 font-modern">
              <option value="buy">{{ _("search.tabs.buy") }}</option>
              <option value="rent">{{ _("search.tabs.rent") }}</option>
              <option value="new_builds">{{ _("navigation.new_builds") }}</option>
            </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("forms.budget_baht") }}</label>
              <div class="flex gap-2">
                <input type="number" name="budget_from" placeholder="{{ _('common.from') }}"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-purple-500 font-modern" />
                <input type="number" name="budget_to" placeholder="{{ _('common.to') }}"
                       class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-purple-500 font-modern" />
              </div>
            </div>
            
            <div>
                          <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("forms.district") }}</label>
            <select name="district" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 font-modern">
              <option value="">{{ _("forms.any_district") }}</option>
              <option value="wongamat">{{ _("districts.wongamat") }}</option>
              <option value="central">{{ _("districts.central") }}</option>
              <option value="jomtien">{{ _("districts.jomtien") }}</option>
              <option value="pratumnak">{{ _("districts.pratumnak") }}</option>
            </select>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("ai.describe_wishes") }}</label>
                          <textarea name="description" rows="4" 
                        placeholder="{{ _('ai.placeholder') }}"
                      class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 font-modern"></textarea>
          </div>
          
          <!-- Кнопка поиска -->
          <div class="text-center">
            <button type="button" onclick="aiSearch()" 
                    class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition-all">
              🤖 {{ _("ai.search_button") }}
            </button>
          </div>
        </form>
      </div>
      
      <!-- Таб: Поиск по карте -->
      <div id="map-tab" class="search-tab-content p-8 space-y-6" style="display: none;">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">🗺️</div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">{{ _("map.title") }}</h3>
          <p class="text-gray-600">{{ _("map.subtitle") }}</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("forms.deal_type") }}</label>
            <select name="map_deal_type" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 font-modern">
              <option value="">{{ _("forms.show_all") }}</option>
              <option value="buy">{{ _("forms.sales_only") }}</option>
              <option value="rent">{{ _("forms.rental_only") }}</option>
              <option value="new_builds">{{ _("forms.new_builds_only") }}</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("forms.property_type") }}</label>
            <select name="map_property_type" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-green-500 font-modern">
              <option value="">{{ _("forms.all_types") }}</option>
              <option value="apartment">{{ _("property.types.apartment") }}</option>
              <option value="villa">{{ _("property.types.villa") }}</option>
              <option value="townhouse">{{ _("property.types.townhouse") }}</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ _("property.budget") }}</label>
            <div class="flex gap-2">
              <input type="number" name="map_price_from" placeholder="От" step="0.1"
                     class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-green-500 font-modern" />
              <input type="number" name="map_price_to" placeholder="До" step="0.1"
                     class="w-full border border-gray-300 rounded-xl px-3 py-3 focus:ring-2 focus:ring-green-500 font-modern" />
            </div>
          </div>
        </div>
        
        <!-- Кнопка перехода на карту -->
        <div class="text-center">
          <button type="button" onclick="openMapSearch()" 
                  class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-xl shadow-lg transition-all">
            🗺️ {{ _("map.open_button") }}
          </button>
        </div>
      </div>
    </div>

      <!-- Расширенные фильтры -->
      <div id="extra-filters" class="overflow-hidden transition-all duration-500 ease-in-out max-h-0">
        <div class="mt-8 p-6 bg-white rounded-2xl border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Дополнительные параметры</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="flex flex-col">
                <span class="mb-2 text-sm font-medium text-gray-700">Дата заезда</span>
                <input type="date" name="checkin_date" class="border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent font-modern" />
              </label>
            </div>
            
            <div class="md:col-span-2">
              <span class="block mb-3 text-sm font-medium text-gray-700">Удобства</span>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="available_now" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">✅ Свободно сейчас</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="pets_allowed" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🐕 {{ _("amenities.pets_allowed") }}</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="private_pool" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🏊 {{ _("amenities.private_pool") }}</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="balcony" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🏠 Балкон</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="sea_view" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🌊 {{ _("Вид на море") }}</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="parking" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🚗 Парковка</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="gym" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">💪 Фитнес-зал</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="wifi" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">📶 Wi-Fi</span>
                </label>
                <label class="inline-flex items-center">
                  <input type="checkbox" name="washing_machine" class="form-checkbox text-blue-600 rounded mr-2" />
                  <span class="text-sm">🧺 Стиральная машина</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Результаты поиска -->
      <div id="results" class="mt-12">
        <div id="property-list">
          {% include 'components/property_cards.html' %}
        </div>
      </div>

      <!-- Индикатор загрузки -->
      <div id="loading-indicator" class="text-center py-8 hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <span class="text-gray-500 text-lg">Загрузка...</span>
      </div>

      <!-- Кнопка "Показать ещё" -->
      <div class="text-center pt-8">
        <button
          id="load-more"
          hx-get="/properties/filter?page=2"
          hx-target="#results"
          hx-include="#filter-form"
          hx-swap="afterend"
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-2xl shadow-lg transition-all transform hover:scale-105">
          Показать ещё объекты
        </button>
      </div>
    </form>
  </div>
</section>

<!-- Секция карты -->
<section id="property-map" class="bg-gray-100 py-16">
  <div class="max-w-7xl mx-auto px-4">
    <div class="text-center mb-10">
      <h2 class="text-3xl md:text-4xl font-bold font-heading text-gray-900 mb-4">
        📍 Карта недвижимости
      </h2>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Найдите недвижимость на интерактивной карте Паттайи
      </p>
    </div>
    
    <!-- Карта -->
    <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
      <div id="map-container" class="relative">
        <div id="map" class="w-full h-[500px] md:h-[600px]"></div>
        
        <!-- Панель фильтров и управления -->
        <div class="absolute top-4 left-4 z-10">
          <div class="bg-white rounded-xl shadow-lg p-4 space-y-4">
            <!-- Заголовок фильтров -->
            <div class="flex items-center justify-between">
              <h3 class="font-semibold text-gray-900">🔍 Фильтры карты</h3>
              <button onclick="toggleMapFilters()" id="filter-toggle-btn" class="text-gray-500 hover:text-gray-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </div>
            
            <!-- Основные фильтры (всегда видимы) -->
            <div class="space-y-3">
              <!-- Типы недвижимости с чекбоксами -->
              <div class="space-y-2">
                                 <label class="flex items-center gap-2 cursor-pointer">
                   <input type="checkbox" id="filter-rent" class="property-filter rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-type="rent" checked>
                   <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                   <span class="text-sm font-medium">Аренда</span>
                 </label>
                 
                 <label class="flex items-center gap-2 cursor-pointer">
                   <input type="checkbox" id="filter-sale" class="property-filter rounded border-gray-300 text-green-600 focus:ring-green-500" data-type="sale" checked>
                   <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                   <span class="text-sm font-medium">Продажа</span>
                 </label>
                 
                 <label class="flex items-center gap-2 cursor-pointer">
                   <input type="checkbox" id="filter-newbuilds" class="property-filter rounded border-gray-300 text-purple-600 focus:ring-purple-500" data-type="newbuilds" checked>
                   <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                   <span class="text-sm font-medium">Новостройки</span>
                 </label>
              </div>
            </div>
            
            <!-- Расширенные фильтры (скрываемые) -->
            <div id="extended-map-filters" class="space-y-3 max-h-0 overflow-hidden transition-all duration-300">
              <!-- Быстрые действия -->
              <div class="border-t pt-3 space-y-2">
                <button onclick="showOnlyNewBuilds()" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white text-sm py-2 px-3 rounded-lg transition-colors">
                  🏗️ {{ _("Только новостройки") }}
                </button>
                
                <button onclick="openAiSearchModal()" 
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white text-sm py-2 px-3 rounded-lg transition-colors">
                  🤖 ИИ-подбор
                </button>
                
                <button onclick="resetMapFilters()" 
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white text-sm py-2 px-3 rounded-lg transition-colors">
                  🔄 Сбросить
                </button>
              </div>
              
              <!-- Дополнительные фильтры -->
              <div class="border-t pt-3 space-y-2">
                <div class="text-xs font-medium text-gray-700 mb-2">Цена (млн ฿):</div>
                <div class="flex gap-2">
                  <input type="number" id="price-from" placeholder="От" 
                         class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                  <input type="number" id="price-to" placeholder="До" 
                         class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                </div>
                
                <div class="text-xs font-medium text-gray-700 mb-1 mt-3">Спален:</div>
                <select id="bedrooms-filter" class="w-full text-xs px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                                <option value="">{{ _("Любое количество") }}</option>
              <option value="0">{{ _("Студия") }}</option>
              <option value="1">{{ _("1 спальня") }}</option>
              <option value="2">{{ _("2 спальни") }}</option>
              <option value="3">{{ _("3+ спален") }}</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Кнопки управления -->
        <div class="absolute top-4 right-4 z-10 space-y-2">
          <button onclick="centerMap()" class="bg-white hover:bg-gray-50 p-3 rounded-xl shadow-lg transition-colors">
            🎯 Центр
          </button>
          <button onclick="toggleSatellite()" class="bg-white hover:bg-gray-50 p-3 rounded-xl shadow-lg transition-colors">
            🛰️ Спутник
          </button>
        </div>
      </div>
    </div>
    
    <!-- Популярные районы -->
    <div class="mt-12 grid grid-cols-2 md:grid-cols-4 gap-4">
      <button onclick="goToDistrict('wongamat')" class="bg-white hover:bg-blue-50 p-4 rounded-xl shadow-lg transition-all text-left">
        <div class="font-semibold text-gray-900">Вонгамат</div>
        <div class="text-sm text-gray-500">Премиум район</div>
      </button>
      <button onclick="goToDistrict('central')" class="bg-white hover:bg-blue-50 p-4 rounded-xl shadow-lg transition-all text-left">
        <div class="font-semibold text-gray-900">Центральная Паттайя</div>
        <div class="text-sm text-gray-500">Торговый центр</div>
      </button>
      <button onclick="goToDistrict('jomtien')" class="bg-white hover:bg-blue-50 p-4 rounded-xl shadow-lg transition-all text-left">
        <div class="font-semibold text-gray-900">Джомтьен</div>
        <div class="text-sm text-gray-500">Тихий пляж</div>
      </button>
      <button onclick="goToDistrict('pratumnak')" class="bg-white hover:bg-blue-50 p-4 rounded-xl shadow-lg transition-all text-left">
        <div class="font-semibold text-gray-900">Пратамнак</div>
        <div class="text-sm text-gray-500">Элитная зона</div>
      </button>
    </div>
  </div>
</section>

<script>
  // Переключение дополнительных фильтров
  let filtersExpanded = false;
  function toggleFilters() {
    const filters = document.getElementById('extra-filters');
    filtersExpanded = !filtersExpanded;
    
    if (filtersExpanded) {
      filters.classList.remove('max-h-0');
      filters.classList.add('max-h-[1000px]');
    } else {
      filters.classList.add('max-h-0');
      filters.classList.remove('max-h-[1000px]');
    }
  }
  
  // Инициализация карты
  let map;
  let satelliteView = false;
  let allMarkers = {
    rent: [],
    sale: [],
    newbuilds: []
  };
  
  function initMap() {
    // Инициализация карты Leaflet
    map = L.map('map').setView([12.9236, 100.8825], 12); // Координаты Паттайи
    
    // Добавление базового слоя
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Добавление примеров маркеров
    addSampleMarkers();
    
    // Инициализация обработчиков фильтров
    initMapFilters();
  }
  
  function addSampleMarkers() {
    // Создание иконок
    const greenIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    const purpleIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    // Маркеры аренды (синие)
    const rentMarker1 = L.marker([12.9336, 100.8825]).addTo(map)
      .bindPopup('<b>Кондо для аренды</b><br>25,000 ฿/месяц<br>2 спальни, 80м²');
    
    const rentMarker2 = L.marker([12.9436, 100.8925]).addTo(map)
      .bindPopup('<b>Студия у моря</b><br>18,000 ฿/месяц<br>Студия, 35м²');
    
    const rentMarker3 = L.marker([12.9136, 100.8725]).addTo(map)
      .bindPopup('<b>Вилла с бассейном</b><br>85,000 ฿/месяц<br>4 спальни, 300м²');
    
    allMarkers.rent = [rentMarker1, rentMarker2, rentMarker3];
    
    // Маркеры продажи (зеленые)
    const saleMarker1 = L.marker([12.9136, 100.8925], {icon: greenIcon}).addTo(map)
      .bindPopup('<b>Квартира на продажу</b><br>4,500,000 ฿<br>3 спальни, 120м²');
      
    const saleMarker2 = L.marker([12.9236, 100.8725], {icon: greenIcon}).addTo(map)
      .bindPopup('<b>Пентхаус</b><br>12,800,000 ฿<br>4 спальни, 250м²');
      
    const saleMarker3 = L.marker([12.9036, 100.8925], {icon: greenIcon}).addTo(map)
      .bindPopup('<b>Кондо в центре</b><br>2,900,000 ฿<br>1 спальня, 65м²');
    
    allMarkers.sale = [saleMarker1, saleMarker2, saleMarker3];
    
    // Маркеры новостроек (фиолетовые)
    const newBuildMarker1 = L.marker([12.9036, 100.8725], {icon: purpleIcon}).addTo(map)
      .bindPopup('<b>Новостройка</b><br>PTY Residence<br>от 3,200,000 ฿');
      
    const newBuildMarker2 = L.marker([12.9536, 100.8825], {icon: purpleIcon}).addTo(map)
      .bindPopup('<b>Новый проект</b><br>Zenith Tower<br>от 5,500,000 ฿');
      
    const newBuildMarker3 = L.marker([12.8936, 100.8625], {icon: purpleIcon}).addTo(map)
      .bindPopup('<b>Строится</b><br>Ocean View<br>от 2,800,000 ฿');
    
    allMarkers.newbuilds = [newBuildMarker1, newBuildMarker2, newBuildMarker3];
    
    // Открытие первого popup
    rentMarker1.openPopup();
  }
  
  function centerMap() {
    map.setView([12.9236, 100.8825], 12);
  }
  
  function toggleSatellite() {
    // Переключение между обычным и спутниковым видом
    if (!satelliteView) {
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles © Esri'
      }).addTo(map);
      satelliteView = true;
    } else {
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      satelliteView = false;
    }
  }
  
  function goToDistrict(district) {
    const districts = {
      'wongamat': [12.9536, 100.8725],
      'central': [12.9236, 100.8825],
      'jomtien': [12.8736, 100.8925],
      'pratumnak': [12.9036, 100.8825]
    };
    
    if (districts[district]) {
      map.setView(districts[district], 14);
    }
  }
  
  // === ФУНКЦИИ ДЛЯ ФИЛЬТРОВ КАРТЫ ===
  
  // Инициализация обработчиков фильтров
  function initMapFilters() {
    // Обработчики для чекбоксов фильтров
    document.querySelectorAll('.property-filter').forEach(checkbox => {
      checkbox.addEventListener('change', updateMapMarkers);
    });
    
    // Обработчики для дополнительных фильтров
    document.getElementById('price-from').addEventListener('input', updateMapMarkers);
    document.getElementById('price-to').addEventListener('input', updateMapMarkers);
    document.getElementById('bedrooms-filter').addEventListener('change', updateMapMarkers);
  }
  
  // Переключение расширенных фильтров
  function toggleMapFilters() {
    const filtersPanel = document.getElementById('extended-map-filters');
    const toggleBtn = document.getElementById('filter-toggle-btn');
    
    if (filtersPanel.style.maxHeight === '0px' || !filtersPanel.style.maxHeight) {
      filtersPanel.style.maxHeight = '400px';
      toggleBtn.style.transform = 'rotate(180deg)';
    } else {
      filtersPanel.style.maxHeight = '0px';
      toggleBtn.style.transform = 'rotate(0deg)';
    }
  }
  
  // Обновление видимости маркеров на основе фильтров
  function updateMapMarkers() {
    const filters = {
      rent: document.getElementById('filter-rent').checked,
      sale: document.getElementById('filter-sale').checked,
      newbuilds: document.getElementById('filter-newbuilds').checked
    };
    
    // Показ/скрытие маркеров по типам
    Object.keys(allMarkers).forEach(type => {
      allMarkers[type].forEach(marker => {
        if (filters[type]) {
          marker.addTo(map);
        } else {
          map.removeLayer(marker);
        }
      });
    });
  }
  
  // Показать только новостройки
  function showOnlyNewBuilds() {
    // Снимаем все чекбоксы
    document.getElementById('filter-rent').checked = false;
    document.getElementById('filter-sale').checked = false;
    document.getElementById('filter-newbuilds').checked = true;
    
    // Обновляем маркеры
    updateMapMarkers();
    
    // Центрируем карту на новостройках
    if (allMarkers.newbuilds.length > 0) {
      const group = new L.featureGroup(allMarkers.newbuilds);
      map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Показываем уведомление
    showMapNotification('🏗️ Показаны только новостройки', 'purple');
  }
  
  // Сброс всех фильтров
  function resetMapFilters() {
    // Включаем все чекбоксы
    document.getElementById('filter-rent').checked = true;
    document.getElementById('filter-sale').checked = true;
    document.getElementById('filter-newbuilds').checked = true;
    
    // Очищаем дополнительные фильтры
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('bedrooms-filter').value = '';
    
    // Обновляем маркеры
    updateMapMarkers();
    
    // Возвращаем карту в исходное положение
    map.setView([12.9236, 100.8825], 12);
    
    showMapNotification('🔄 Фильтры сброшены', 'gray');
  }
  
  // Показ уведомлений на карте
  function showMapNotification(message, color = 'blue') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `fixed top-20 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium transition-all duration-300`;
    
    // Выбор цвета
    const colors = {
      purple: 'bg-purple-600',
      gray: 'bg-gray-600',
      blue: 'bg-blue-600',
      green: 'bg-green-600'
    };
    notification.classList.add(colors[color] || colors.blue);
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Показываем уведомление
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translate(-50%, 0)';
    }, 100);
    
    // Скрываем через 3 секунды
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translate(-50%, -20px)';
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }
  
  // === КОНЕЦ ФУНКЦИЙ ФИЛЬТРОВ ===
  
  // Инициализация карты при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    initMap();
  });
  
  // === ОСНОВНЫЕ ФУНКЦИИ ИНТЕРФЕЙСА ===
  
  // Скролл к секции поиска
  function scrollToSearch() {
    document.getElementById('search-section').scrollIntoView({ 
      behavior: 'smooth' 
    });
  }
  
  // Переключение между табами поиска
  function switchSearchTab(tabName) {
    // Убираем активный класс со всех табов
    document.querySelectorAll('.search-tab').forEach(tab => {
      tab.classList.remove('active', 'bg-blue-100', 'bg-green-100', 'bg-purple-100', 'text-blue-700', 'text-green-700', 'text-purple-700');
      tab.classList.add('text-gray-600');
    });
    
    // Скрываем все содержимое табов
    document.querySelectorAll('.search-tab-content').forEach(content => {
      content.style.display = 'none';
    });
    
    // Активируем выбранный таб
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    const activeContent = document.getElementById(`${tabName}-tab`);
    
    if (activeTab && activeContent) {
      activeTab.classList.add('active');
      activeTab.classList.remove('text-gray-600');
      
      // Добавляем специфичные цвета для каждого таба
      if (tabName === 'buy') {
        activeTab.classList.add('bg-blue-100', 'text-blue-700');
      } else if (tabName === 'rent') {
        activeTab.classList.add('bg-green-100', 'text-green-700');
      } else if (tabName === 'ai') {
        activeTab.classList.add('bg-purple-100', 'text-purple-700');
      } else if (tabName === 'map') {
        activeTab.classList.add('bg-green-100', 'text-green-700');
      }
      
      activeContent.style.display = 'block';
    }
  }
  
  // Поиск недвижимости
  function searchProperties(dealType) {
    const form = document.querySelector(`#${dealType}-tab form`);
    if (!form) return;
    
    // Показываем индикатор загрузки
    showLoadingIndicator();
    
    // Собираем данные формы
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
      if (value.trim()) {
        params.append(key, value);
      }
    }
    
    // Добавляем тип сделки
    params.set('deal_type', dealType);
    
    // Перенаправляем на страницу результатов
    window.location.href = `/{{ lang }}/properties?${params.toString()}`;
  }
  
  // ИИ-поиск недвижимости
  function aiSearch() {
    const form = document.querySelector('#ai-tab form');
    if (!form) return;
    
    const description = form.querySelector('[name="description"]').value;
    const searchType = form.querySelector('[name="search_type"]').value;
    const budgetFrom = form.querySelector('[name="budget_from"]').value;
    const budgetTo = form.querySelector('[name="budget_to"]').value;
    const district = form.querySelector('[name="district"]').value;
    
    if (!description.trim()) {
      alert('Пожалуйста, опишите ваши пожелания');
      return;
    }
    
    // Показываем индикатор загрузки
    showLoadingIndicator();
    
    // Собираем параметры для ИИ-поиска
    const params = new URLSearchParams({
      ai_search: 'true',
      description: description,
      deal_type: searchType,
      budget_from: budgetFrom || '',
      budget_to: budgetTo || '',
      district: district || ''
    });
    
    // Перенаправляем на страницу ИИ-поиска
    window.location.href = `/{{ lang }}/ai-search?${params.toString()}`;
  }
  
  // Открытие поиска по карте
  function openMapSearch() {
    const form = document.querySelector('#map-tab form');
    if (!form) return;
    
    const dealType = form.querySelector('[name="map_deal_type"]').value;
    const propertyType = form.querySelector('[name="map_property_type"]').value;
    const priceFrom = form.querySelector('[name="map_price_from"]').value;
    const priceTo = form.querySelector('[name="map_price_to"]').value;
    
    // Собираем параметры
    const params = new URLSearchParams({
      view: 'map',
      deal_type: dealType || '',
      property_type: propertyType || '',
      price_from: priceFrom || '',
      price_to: priceTo || ''
    });
    
    // Перенаправляем на карту
    window.location.href = `/{{ lang }}/properties/map?${params.toString()}`;
  }
  
  // Открытие модального окна ИИ-поиска
  function openAiSearchModal() {
    // Переключаемся на таб ИИ-поиска
    switchSearchTab('ai');
    
    // Скроллим к секции поиска
    scrollToSearch();
    
    // Фокусируемся на поле описания
    setTimeout(() => {
      const descriptionField = document.querySelector('#ai-tab textarea[name="description"]');
      if (descriptionField) {
        descriptionField.focus();
      }
    }, 500);
  }
  
  // Показать индикатор загрузки
  function showLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
      indicator.classList.remove('hidden');
    }
  }
  
  // Скрыть индикатор загрузки
  function hideLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
      indicator.classList.add('hidden');
    }
  }
  
  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    // Устанавливаем первый таб активным по умолчанию
    switchSearchTab('buy');
    
    // Скрываем индикатор загрузки
    hideLoadingIndicator();
    
    // Добавляем автоматический поиск при изменении фильтров
    initAutoSearch();
  });
  
  // Автоматический поиск при изменении фильтров
  function initAutoSearch() {
    // Получаем все формы поиска
    const searchForms = document.querySelectorAll('#buy-tab form, #rent-tab form');
    
    searchForms.forEach((form, index) => {
      const dealType = index === 0 ? 'buy' : 'rent';
      
      // Добавляем обработчики для всех полей
      const inputs = form.querySelectorAll('input, select');
      inputs.forEach(input => {
        // Поиск при изменении текстовых полей (с задержкой)
        if (input.type === 'text' || input.type === 'number') {
          let timeout;
          input.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
              if (hasValidSearchParams(form)) {
                searchProperties(dealType);
              }
            }, 1000); // Поиск через 1 секунду после остановки ввода
          });
        }
        
        // Немедленный поиск при изменении селектов и чекбоксов
        if (input.type === 'select-one' || input.type === 'checkbox') {
          input.addEventListener('change', function() {
            if (hasValidSearchParams(form)) {
              searchProperties(dealType);
            }
          });
        }
      });
    });
  }
  
  // Проверка на наличие хотя бы одного заполненного параметра поиска
  function hasValidSearchParams(form) {
    const formData = new FormData(form);
    let hasParams = false;
    
    for (let [key, value] of formData.entries()) {
      if (key !== 'deal_type' && value.trim()) {
        hasParams = true;
        break;
      }
    }
    
    return hasParams;
  }
</script>
{% endblock %}
